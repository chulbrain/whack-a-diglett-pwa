import { useState, useEffect, useRef } from "react";
import { motion, AnimatePresence } from "framer-motion";
import * as Tone from 'tone';

// ë‘ë”ì§€ ì´ë¯¸ì§€ URL
const diglettImageURL = "https://assets.pokemon.com/assets/cms2/img/pokedex/full/050.png";

// ë§ˆìš°ìŠ¤ ì»¤ì„œìš© ì¸ë¼ì¸ SVG ë§ì¹˜ (í¬ê¸°: 48x48)
const hammerSvgForCursor = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
  <g transform="rotate(15 24 24)">
    {/* Hammer Head (ë¹¨ê°„ìƒ‰) */}
    <rect x="6" y="2" width="36" height="18" rx="6" ry="6" fill="#DC2626" /> 
    {/* Hammer Handle (ê°ˆìƒ‰) */}
    <rect x="20" y="18" width="8" height="28" rx="3" ry="3" fill="#A16207" />
  </g>
</svg>`;
const hammerCursorDataURL = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(hammerSvgForCursor)}`;


// ë‚œì´ë„ë³„ ë‘ë”ì§€ ì¶œí˜„ ê°„ê²© (ë°€ë¦¬ì´ˆ)
const DIFFICULTY_LEVELS = {
  easy: { label: "ì‰¬ì›€ ğŸ˜Š", interval: 1200 },
  normal: { label: "ë³´í†µ ğŸ™‚", interval: 900 },
  hard: { label: "ì–´ë ¤ì›€ ğŸ˜ ", interval: 600 },
};

// í‡´ì¥í•˜ëŠ” ë‘ë”ì§€ë¥¼ ë§ì¶œ ìˆ˜ ìˆëŠ” ìœ ì˜ˆ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
const EXIT_GRACE_PERIOD = 450;

// í´ë¦­ ì‹œ ë‚˜íƒ€ë‚˜ëŠ” ì• ë‹ˆë©”ì´ì…˜ìš© ë§ì¹˜ ì•„ì´ì½˜
const AnimatedHammerIcon = () => (
  <svg width="60" height="60" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" style={{ transformOrigin: "bottom center" }}>
    <g transform="rotate(15 24 24)">
      <rect x="6" y="2" width="36" height="18" rx="6" ry="6" fill="#DC2626" />
      <rect x="20" y="18" width="8" height="28" rx="3" ry="3" fill="#A16207" />
    </g>
  </svg>
);

export default function WhackADiglett() {
  const [score, setScore] = useState(0);
  const [timeLeft, setTimeLeft] = useState(0);
  const [running, setRunning] = useState(false);
  const [activeIndex, setActiveIndex] = useState<number | null>(null);
  const [previousActiveIndexInfo, setPreviousActiveIndexInfo] = useState<{ index: number, deactivationTime: number } | null>(null);
  
  const [hitIndex, setHitIndex] = useState<number | null>(null);
  const [hammerState, setHammerState] = useState<{ holeIndex: number | null, key: number }>({ holeIndex: null, key: 0 });
  
  const [difficulty, setDifficulty] = useState<'easy' | 'normal' | 'hard'>('normal');
  const [currentMoleInterval, setCurrentMoleInterval] = useState(DIFFICULTY_LEVELS.normal.interval);

  const intervalRef = useRef<NodeJS.Timeout | null>(null);
  const timerRef = useRef<NodeJS.Timeout | null>(null);
  const hitSound = useRef<Tone.Synth | null>(null);

  const HOLES = 16;
  const GAME_DURATION = 30;

  useEffect(() => {
    hitSound.current = new Tone.Synth().toDestination();
    return () => {
      intervalRef.current && clearInterval(intervalRef.current);
      timerRef.current && clearInterval(timerRef.current);
    };
  }, []);

  useEffect(() => {
    setCurrentMoleInterval(DIFFICULTY_LEVELS[difficulty].interval);
  }, [difficulty]);

  const startGame = async () => {
    if (Tone.context.state !== 'running') {
      await Tone.start();
    }
    setScore(0);
    setTimeLeft(GAME_DURATION);
    setRunning(true);
    setActiveIndex(null);
    setPreviousActiveIndexInfo(null);
    setHitIndex(null);
    setHammerState({ holeIndex: null, key: 0 });

    intervalRef.current && clearInterval(intervalRef.current);
    intervalRef.current = setInterval(() => {
      if (activeIndex !== null) {
        setPreviousActiveIndexInfo({ index: activeIndex, deactivationTime: Date.now() });
      }
      setActiveIndex(Math.floor(Math.random() * HOLES));
    }, currentMoleInterval); 

    timerRef.current && clearInterval(timerRef.current);
    timerRef.current = setInterval(() => {
      setTimeLeft((t) => {
        if (t <= 1) {
          clearInterval(timerRef.current!);
          clearInterval(intervalRef.current!);
          setRunning(false);
          setActiveIndex(null);
          setPreviousActiveIndexInfo(null);
          return 0;
        }
        return t - 1;
      });
    }, 1000);
  };

  const bonk = (clickedIndex: number) => {
    if (!running || !hitSound.current) return;

    let isHit = false;
    let hitMoleIndex = -1;

    if (activeIndex !== null && clickedIndex === activeIndex) {
      isHit = true;
      hitMoleIndex = activeIndex;
      setActiveIndex(null);
      setPreviousActiveIndexInfo(null);
    } 
    else if (previousActiveIndexInfo && clickedIndex === previousActiveIndexInfo.index && 
             (Date.now() - previousActiveIndexInfo.deactivationTime < EXIT_GRACE_PERIOD)) {
      isHit = true;
      hitMoleIndex = previousActiveIndexInfo.index;
      setPreviousActiveIndexInfo(null);
    }

    if (isHit) {
      setScore((s) => s + 1);
      setHitIndex(hitMoleIndex);
      setHammerState({ holeIndex: hitMoleIndex, key: Date.now() });
      
      hitSound.current.triggerAttackRelease("C3", "8n", Tone.now());
      setTimeout(() => setHitIndex(null), 300);
      setTimeout(() => {
         setHammerState(prevState => prevState.holeIndex === hitMoleIndex ? { holeIndex: null, key: 0 } : prevState);
      }, 600);
    }
  };

  const handleDifficultyChange = (level: 'easy' | 'normal' | 'hard') => {
    setDifficulty(level);
  };

  return (
    <>
      <style>{`
        .hammer-cursor-active { cursor: url("${hammerCursorDataURL}") 24 38, auto; }
        .hole-container:hover { filter: brightness(1.1); }
        .difficulty-button { 
          padding: 0.5rem 0.75rem; /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ íŒ¨ë”© ì•½ê°„ ì¡°ì • */
          font-size: 0.875rem; /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ í°íŠ¸ ì•½ê°„ ì‘ê²Œ */
          border-radius: 0.5rem; 
          font-weight: bold; 
          transition: all 0.2s; 
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        @media (min-width: 640px) { /* sm breakpoint ì´ìƒ */
          .difficulty-button {
            padding: 0.5rem 1rem;
            font-size: 1rem;
          }
        }
        .difficulty-button-selected { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
      `}</style>
      {/* ì „ì²´ ì»¨í…Œì´ë„ˆ: ëª¨ë°”ì¼ì—ì„œëŠ” p-2, sm ì´ìƒì—ì„œëŠ” p-4 */}
      <div className={`min-h-screen flex flex-col items-center justify-center gap-4 sm:gap-6 bg-gradient-to-br from-rose-100 to-amber-100 p-2 sm:p-4 font-sans ${running ? "hammer-cursor-active" : ""}`}>
        {/* íƒ€ì´í‹€: ëª¨ë°”ì¼ì—ì„œëŠ” text-3xl, sm ì´ìƒì—ì„œëŠ” text-4xl */}
        <h1 className="text-3xl sm:text-4xl font-bold text-amber-700 mb-1 sm:mb-2 text-center">Whack-a-Diglett!</h1>

        {/* ë‚œì´ë„ ì„ íƒ UI: ëª¨ë°”ì¼ì—ì„œëŠ” mb-2, sm ì´ìƒì—ì„œëŠ” mb-4. ë²„íŠ¼ ê°„ê²© gap-1 ë˜ëŠ” gap-2 */}
        {!running && (
          <div className="mb-2 sm:mb-4 p-3 sm:p-4 bg-white/70 rounded-lg shadow-md w-full max-w-xs sm:max-w-sm md:max-w-md">
            <h2 className="text-base sm:text-lg font-semibold text-amber-600 mb-2 text-center">ë‚œì´ë„ ì„ íƒ:</h2>
            <div className="flex justify-center gap-1 sm:gap-2">
              {(Object.keys(DIFFICULTY_LEVELS) as Array<keyof typeof DIFFICULTY_LEVELS>).map((level) => (
                <button
                  key={level}
                  onClick={() => handleDifficultyChange(level)}
                  className={`difficulty-button flex-grow sm:flex-grow-0
                    ${difficulty === level ? 'bg-indigo-500 text-white difficulty-button-selected' : 'bg-slate-200 hover:bg-slate-300 text-slate-700'} 
                    ${level === 'easy' ? 'hover:bg-green-400' : level === 'normal' ? 'hover:bg-blue-400' : 'hover:bg-red-400'}`}
                >
                  {DIFFICULTY_LEVELS[level].label}
                </button>
              ))}
            </div>
          </div>
        )}

        {/* ì ìˆ˜íŒ: ëª¨ë°”ì¼ì—ì„œëŠ” text-lg, sm ì´ìƒì—ì„œëŠ” text-xl. íŒ¨ë”© p-3 sm:p-4 */}
        <div className="flex flex-col sm:flex-row gap-2 sm:gap-4 items-center text-lg sm:text-xl font-semibold bg-white/70 p-3 sm:p-4 rounded-lg shadow-md">
          <div className="text-amber-600">â±ï¸ ì‹œê°„: <span className="text-blue-600 w-8 inline-block text-center">{timeLeft}ì´ˆ</span></div>
          <div className="text-amber-600">ğŸ¯ ì ìˆ˜: <span className="text-red-600 w-8 inline-block text-center">{score}</span></div>
        </div>
        
        {/* ê²Œì„ ë³´ë“œ: ëª¨ë°”ì¼ì—ì„œëŠ” gap-1 ë˜ëŠ” gap-2, sm ì´ìƒì—ì„œëŠ” gap-2 ë˜ëŠ” gap-4. íŒ¨ë”© p-2 sm:p-4 */}
        {/* ê²Œì„ ë³´ë“œ ì»¨í…Œì´ë„ˆì˜ ìµœëŒ€ ë„ˆë¹„ë¥¼ ì œí•œí•˜ì—¬ ëª¨ë°”ì¼ì—ì„œ ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šë„ë¡ í•¨ */}
        {running && (
          <div className="w-full max-w-xs sm:max-w-sm md:max-w-md">
            <div className="grid grid-cols-4 gap-1 xxs:gap-2 xs:gap-2 sm:gap-3 p-2 sm:p-4 bg-green-300 rounded-2xl shadow-xl">
              {Array.from({ length: HOLES }).map((_, idx) => (
                // êµ¬ë© í¬ê¸°: ê¸°ë³¸ w-16 h-16, xsì—ì„œ w-16 h-16, smì—ì„œ w-20 h-20, mdì—ì„œ w-24 h-24
                // Tailwind JIT ëª¨ë“œì—ì„œëŠ” xxs, xs ê°™ì€ ì»¤ìŠ¤í…€ breakpointë¥¼ ì„¤ì •í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ sm, mdë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                // ì—¬ê¸°ì„œëŠ” w-full aspect-squareë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ì‚¬ê°í˜•ì„ ìœ ì§€í•˜ë„ë¡ í•˜ê³ , ë¶€ëª¨ gridì˜ í¬ê¸°ì— ë”°ë¼ ì¡°ì ˆë˜ë„ë¡ í•©ë‹ˆë‹¤.
                <div 
                  key={idx} 
                  onClick={() => bonk(idx)} 
                  // íŒ¨ë”©ì„ ì´ìš©í•´ ë‚´ë¶€ ì»¨í…ì¸  ì˜ì—­ í™•ë³´ ë° í„°ì¹˜ ì˜ì—­ ìœ ì§€
                  className="hole-container p-0.5 xxs:p-1 xs:p-1 sm:p-1.5 rounded-full bg-yellow-600/80 shadow-inner relative select-none overflow-hidden border-2 sm:border-4 border-yellow-700/90 flex items-center justify-center group"
                  style={{ aspectRatio: '1 / 1' }} // ì •ì‚¬ê°í˜• ë¹„ìœ¨ ìœ ì§€
                >
                  <div className="absolute inset-[10%] rounded-full bg-black/30 group-hover:bg-black/40 transition-colors"></div>
                  <AnimatePresence>
                    {idx === activeIndex && (
                      <motion.img
                        src={diglettImageURL} alt="Diglett"
                        initial={{ y: "100%", scale: 0.8 }} animate={{ y: "5%", scale: 1 }} exit={{ y: "100%", scale: 0.8, opacity: 0 }}
                        transition={{ type: "spring", stiffness: 300, damping: 15 }}
                        className="absolute bottom-0 w-[80%] h-[80%] object-contain z-10" />
                    )}
                  </AnimatePresence>
                  <AnimatePresence>
                    {idx === hitIndex && (
                      <motion.div
                        initial={{ scale: 0.6, opacity: 1 }} animate={{ scale: 1.4, opacity: 0 }} exit={{ opacity: 0 }}
                        transition={{ duration: 0.3 }}
                        // ë°˜ì§ì„ íš¨ê³¼ í¬ê¸° ë°˜ì‘í˜•ìœ¼ë¡œ ì¡°ì ˆ
                        className="absolute inset-0 flex items-center justify-center pointer-events-none z-20">
                        <span className="text-3xl sm:text-4xl md:text-5xl">âœ¨</span>
                      </motion.div>
                    )}
                  </AnimatePresence>
                  <AnimatePresence>
                    {hammerState.holeIndex === idx && (
                      <motion.div
                        key={hammerState.key}
                        initial={{ y: -50, rotate: -45, scale: 0.7, opacity: 0 }}
                        animate={{ y: -5, rotate: 0, scale: 1, opacity: 1, transition: { type: "spring", stiffness: 500, damping: 12, mass: 0.8 } }}
                        exit={{ y: -30, rotate: 30, scale: 0.5, opacity: 0, transition: { duration: 0.25, ease: "easeOut" } }}
                        className="absolute z-30 pointer-events-none" 
                        style={{ top: '0%', left: '50%', x: '-50%' }} >
                        {/* ì• ë‹ˆë©”ì´ì…˜ ë§ì¹˜ ì•„ì´ì½˜ í¬ê¸° ë°˜ì‘í˜• ì¡°ì ˆ (SVG width/heightë¥¼ %ë¡œ í•˜ê±°ë‚˜, ë¶€ëª¨ div í¬ê¸°ì— ë§ì¶”ëŠ” ë°©ì‹ ê³ ë ¤) */}
                        {/* ì—¬ê¸°ì„œëŠ” AnimatedHammerIcon ë‚´ë¶€ SVG í¬ê¸°ë¥¼ ê³ ì •í–ˆìœ¼ë¯€ë¡œ, scaleë¡œ ì¡°ì ˆí•˜ëŠ” ê²ƒì´ ë” ì í•©í•  ìˆ˜ ìˆìŒ */}
                        <AnimatedHammerIcon />
                      </motion.div>
                    )}
                  </AnimatePresence>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* ì‹œì‘/ì¬ì‹œì‘ ë²„íŠ¼: ëª¨ë°”ì¼ì—ì„œëŠ” px-6 py-2.5 text-base, sm ì´ìƒì—ì„œëŠ” px-8 py-3 text-lg */}
        {!running && (
          <button 
            onClick={startGame} 
            className="px-6 sm:px-8 py-2.5 sm:py-3 rounded-xl shadow-lg bg-indigo-500 hover:bg-indigo-600 active:bg-indigo-700 text-white font-bold text-base sm:text-lg transition-all duration-150 ease-in-out transform hover:scale-105 active:scale-95"
          >
            {timeLeft === 0 && score > 0 ? `${DIFFICULTY_LEVELS[difficulty].label}ë¡œ ë‹¤ì‹œ ì‹œì‘ ğŸ` : `${DIFFICULTY_LEVELS[difficulty].label}ë¡œ ì‹œì‘ ğŸ`}
          </button>
        )}

        {/* ê²Œì„ ì¢…ë£Œ ë©”ì‹œì§€: ëª¨ë°”ì¼ text-xl, sm ì´ìƒ text-2xl */}
        {!running && timeLeft === 0 && score > 0 && (
          <div className="text-xl sm:text-2xl font-bold text-amber-800 mt-2 sm:mt-4">ê²Œì„ ì¢…ë£Œ! ìµœì¢… ì ìˆ˜: {score}ì </div>
        )}
      </div>
    </>
  );
}
